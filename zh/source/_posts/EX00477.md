---
title: Outline 极速部署
date: 2024-02-11 22:34:16
updated: 2024-02-14 10:10:00
tags: 
  - WYSIWYG
  - Docker
  - Linux
  - OpenID
categories:
keywords:
description:
  notion 平替
top_img:
comments:
cover:
toc:
toc_number:
toc_style_simple:
mathjax:
katex:
aplayer:
highlight_shrink:
aside:
sticky:
---

看到了[糖喵的前端速成教程](https://nekb.org/s/full-stack-in-7-days)用了 outline，确实好看，又有点想自己搞一个出来，不由得回忆起以前刚开始看 outline 部署的时候。

当时傻不拉叽没想到直接配 SMTP, 也没想到 gitea(forgejo) 是个 OpenID Provider, 可以对接 OIDC. 这些都是后来配熟了才意识到的。

除此之外，最难的就是 S3 了。当时是指定要求使用 S3 存储，但是也没有我能负担得起的 S3 服务商，真的难倒我。当时再加上一些人发的劝退言论，令我很是绝望，就几乎忘记了这玩意的存在。不过这次看到文档说 0.72 以后他们支持了本地文件存储[^1]，就省事很多了。那我觉得还是有些能做出来的希望的。

最近看 notion 替代品的时候，经常有人提到 outline. 虽然肯定不及 notion 和飞书那么强大，但我觉得它姑且算开源，而且我正好缺一个好用的在线 WYSIWYG markdown 编辑器当作草稿箱，而它正好合适，看起来比 standard notes 和 joplin 顺手多了，虽然没有 e2ee. 哦对了，似乎占用也不大，

[^1]: https://docs.getoutline.com/s/hosting/doc/file-storage-N4M0T6Ypu7


## 添加 OAuth App

要拿 forgejo 当作 OpenID Provider, 就要在 forgejo 里面添加一个 application, 然后拿走 client id 和 client secret. 

Callback URL 文档里没写，是等到第一次调用 OIDC 进到授权界面的时候，看到地址栏里有个 redirect 然后得知的，path 是 `/auth/oidc.callback` ，太奇妙了。


![](/asset/img/EX00477/redirect.webp)


## 部署

按照文档，看起来就是一个 docker compose 的事情，那再把 TLS 部分交给 nginx 就行，并不困难。

### 上 compose file

文档中提供了 compose 配置的示例。看到暴露端口的时候就绷不住了，拿下来加以修改。

* 添加 `container_name` 作为内部通信用的 hostname，无需再对外暴露端口。
* 将 volume 改为直接 bind mount 文件夹。

  注意：需要随后将 `storage-data` 文件夹的所有权改为 `1001:65533`，否则无法正常上传文件或导出（可使用 `docker exec -it outline_app sh` 进入容器内，执行 `id -u` 和 `id -g` 自行验证）
* 将 image tag 的版本锁定住。
* 不需要使用单独的反代了，我自己有 nginx. 
* 把 forgejo 的地址解析到它容器所在的网关，那个地址有一个 nginx 监听，不必绕一圈公网了。

```yaml
# docker-compose.yml

version: "3.2"

services:
  outline:
    image: docker.getoutline.com/outlinewiki/outline:0.74.0
    env_file: ./docker.env
    container_name: outline_app
    ports:
      - "127.0.0.1:3000:3000"
    volumes:
      - ./storage-data:/var/lib/outline/data
    depends_on:
      - postgres
      - redis
    extra_hosts: 
      - "forgejo.example.com:172.30.0.1"

  redis:
    image: redis:7.0-alpine
    env_file: ./docker.env
    container_name: outline_redis
    # ports:
      # - "6379:6379"
    volumes:
      - ./redis.conf:/redis.conf
    command: ["redis-server", "/redis.conf"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 30s
      retries: 3

  postgres:
    image: postgres:13-alpine
    env_file: ./docker.env
    container_name: outline_postgres
    # ports:
      # - "5432:5432"
    volumes:
      - ./database-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready"]
      interval: 30s
      timeout: 20s
      retries: 3
    environment:
      POSTGRES_USER: 'user'
      POSTGRES_PASSWORD: 'pass'
      POSTGRES_DB: 'outline'
```


### 改环境变量

文档里提及了 github 上面托管的[示例](https://github.com/outline/outline/blob/main/.env.sample)，拿下来重命名为 `docker.env` 提供给 docker compose 用。

按照自己的需求修改。

| Line | Comment |
|----|----|
| 7, 11 | 自己生成去 |
| 15, 16, 23 | 更改 postgres 和 redis 的地址，就可以在内部 bridge 通信，不用对容器外暴露端口。 |
| 20 | 内部通信，postgres 不开 SSL 了。 |
| 33 | 改成你自己拿来暴露到公网的地址 |
| 48-55, 59 | 使用本地存储 |
| 71-96 | 删去不使用的外部认证配置 |
| 101-106 | 照 forgejo 文档的 [OIDC Endpoints](https://forgejo.org/docs/v1.19/user/oauth2-provider/) 猛抄一遍 |
| 134 | 顺便禁用一些奇妙的 TLS 配置 |
| 138 | 禁用遥测（虽然感觉自欺欺人） |
| 142 | 进程数我开了 4, 看个人需求。 |
| 160-162 | 删去 slack 集成 |
| 175-182 | 考虑到我那个域名邮箱可怜的 quota, 就不配 SMTP 了（后来一看那个邮件通知设置，一堆开关，真能把 quota 用爆，然后塞满我的收件箱。） |

```ini
# –––––––––––––––– REQUIRED ––––––––––––––––

NODE_ENV=production

# Generate a hex-encoded 32-byte random key. You should use `openssl rand -hex 32`
# in your terminal to generate a random value.
SECRET_KEY=<GENERATED_SECRET_1>

# Generate a unique random key. The format is not important but you could still use
# `openssl rand -hex 32` in your terminal to produce this.
UTILS_SECRET=<GENERATED_SECRET_2>

# For production point these at your databases, in development the default
# should work out of the box.
DATABASE_URL=postgres://user:pass@outline_postgres:5432/outline
DATABASE_URL_TEST=postgres://user:pass@outline_postgres:5432/outline-test
DATABASE_CONNECTION_POOL_MIN=
DATABASE_CONNECTION_POOL_MAX=
# Uncomment this to disable SSL for connecting to Postgres
PGSSLMODE=disable

# For redis you can either specify an ioredis compatible url like this
REDIS_URL=redis://outline_redis:6379
# or alternatively, if you would like to provide additional connection options,
# use a base64 encoded JSON connection option object. Refer to the ioredis documentation
# for a list of available options.
# Example: Use Redis Sentinel for high availability
# {"sentinels":[{"host":"sentinel-0","port":26379},{"host":"sentinel-1","port":26379}],"name":"mymaster"}
# REDIS_URL=ioredis://eyJzZW50aW5lbHMiOlt7Imhvc3QiOiJzZW50aW5lbC0wIiwicG9ydCI6MjYzNzl9LHsiaG9zdCI6InNlbnRpbmVsLTEiLCJwb3J0IjoyNjM3OX1dLCJuYW1lIjoibXltYXN0ZXIifQ==

# URL should point to the fully qualified, publicly accessible URL. If using a
# proxy the port in URL and PORT may be different.
URL=https://outline.example.com
PORT=3000

# See [documentation](docs/SERVICES.md) on running a separate collaboration
# server, for normal operation this does not need to be set.
COLLABORATION_URL=

# To support uploading of images for avatars and document attachments an
# s3-compatible storage must be provided. AWS S3 is recommended for redundancy
# however if you want to keep all file storage local an alternative such as
# minio (https://github.com/minio/minio) can be used.

# A more detailed guide on setting up S3 is available here:
# => https://wiki.generaloutline.com/share/125de1cc-9ff6-424b-8415-0d58c809a40f
#
# AWS_ACCESS_KEY_ID=get_a_key_from_aws
# AWS_SECRET_ACCESS_KEY=get_the_secret_of_above_key
# AWS_REGION=xx-xxxx-x
# AWS_S3_ACCELERATE_URL=
# AWS_S3_UPLOAD_BUCKET_URL=http://s3:4569
# AWS_S3_UPLOAD_BUCKET_NAME=bucket_name_here
# AWS_S3_FORCE_PATH_STYLE=true
# AWS_S3_ACL=private

# Specify what storage system to use. Possible value is one of "s3" or "local".
# For "local", the avatar images and document attachments will be saved on local disk. 
FILE_STORAGE=local

# If "local" is configured for FILE_STORAGE above, then this sets the parent directory under
# which all attachments/images go. Make sure that the process has permissions to create
# this path and also to write files to it.
FILE_STORAGE_LOCAL_ROOT_DIR=/var/lib/outline/data

# Maximum allowed size for the uploaded attachment.
FILE_STORAGE_UPLOAD_MAX_SIZE=262144000

# –––––––––––––– AUTHENTICATION ––––––––––––––

# Third party signin credentials, at least ONE OF EITHER Google, Slack,
# or Microsoft is required for a working installation or you'll have no sign-in
# options.

# To configure Slack auth, you'll need to create an Application at
# => https://api.slack.com/apps
#
# When configuring the Client ID, add a redirect URL under "OAuth & Permissions":
# https://<URL>/auth/slack.callback
# SLACK_CLIENT_ID=get_a_key_from_slack
# SLACK_CLIENT_SECRET=get_the_secret_of_above_key

# To configure Google auth, you'll need to create an OAuth Client ID at
# => https://console.cloud.google.com/apis/credentials
#
# When configuring the Client ID, add an Authorized redirect URI:
# https://<URL>/auth/google.callback
# GOOGLE_CLIENT_ID=
# GOOGLE_CLIENT_SECRET=

# To configure Microsoft/Azure auth, you'll need to create an OAuth Client. See
# the guide for details on setting up your Azure App:
# => https://wiki.generaloutline.com/share/dfa77e56-d4d2-4b51-8ff8-84ea6608faa4
# AZURE_CLIENT_ID=
# AZURE_CLIENT_SECRET=
# AZURE_RESOURCE_APP_ID=

# To configure generic OIDC auth, you'll need some kind of identity provider.
# See documentation for whichever IdP you use to acquire the following info:
# Redirect URI is https://<URL>/auth/oidc.callback
OIDC_CLIENT_ID=<YOUR_CLIENT_ID>
OIDC_CLIENT_SECRET=<YOUR_CLIENT_SECRET>
OIDC_AUTH_URI=https://forgejo.example.com/login/oauth/authorize
OIDC_TOKEN_URI=https://forgejo.example.com/login/oauth/access_token
OIDC_USERINFO_URI=https://forgejo.example.com/login/oauth/userinfo

# Specify which claims to derive user information from
# Supports any valid JSON path with the JWT payload
OIDC_USERNAME_CLAIM=preferred_username

# Display name for OIDC authentication
OIDC_DISPLAY_NAME=OpenID Connect

# Space separated auth scopes.
OIDC_SCOPES=openid profile email


# –––––––––––––––– OPTIONAL ––––––––––––––––

# Base64 encoded private key and certificate for HTTPS termination. This is only
# required if you do not use an external reverse proxy. See documentation:
# https://wiki.generaloutline.com/share/1c922644-40d8-41fe-98f9-df2b67239d45
SSL_KEY=
SSL_CERT=

# If using a Cloudfront/Cloudflare distribution or similar it can be set below.
# This will cause paths to javascript, stylesheets, and images to be updated to
# the hostname defined in CDN_URL. In your CDN configuration the origin server
# should be set to the same as URL.
CDN_URL=

# Auto-redirect to https in production. The default is true but you may set to
# false if you can be sure that SSL is terminated at an external loadbalancer.
FORCE_HTTPS=false

# Have the installation check for updates by sending anonymized statistics to
# the maintainers
ENABLE_UPDATES=false

# How many processes should be spawned. As a reasonable rule divide your servers
# available memory by 512 for a rough estimate
WEB_CONCURRENCY=4

# Override the maximum size of document imports, could be required if you have
# especially large Word documents with embedded imagery
MAXIMUM_IMPORT_SIZE=5120000

# You can remove this line if your reverse proxy already logs incoming http
# requests and this ends up being duplicative
DEBUG=http

# Configure lowest severity level for server logs. Should be one of
# error, warn, info, http, verbose, debug and silly
LOG_LEVEL=info

# For a complete Slack integration with search and posting to channels the
# following configs are also needed, some more details
# => https://wiki.generaloutline.com/share/be25efd1-b3ef-4450-b8e5-c4a4fc11e02a
#
# SLACK_VERIFICATION_TOKEN=your_token
# SLACK_APP_ID=A0XXXXXXX
# SLACK_MESSAGE_ACTIONS=true

# Optionally enable google analytics to track pageviews in the knowledge base
# GOOGLE_ANALYTICS_ID=

# Optionally enable Sentry (sentry.io) to track errors and performance,
# and optionally add a Sentry proxy tunnel for bypassing ad blockers in the UI:
# https://docs.sentry.io/platforms/javascript/troubleshooting/#using-the-tunnel-option)
# SENTRY_DSN=
# SENTRY_TUNNEL=

# To support sending outgoing transactional emails such as "document updated" or
# "you've been invited" you'll need to provide authentication for an SMTP server
# SMTP_HOST=
# SMTP_PORT=
# SMTP_USERNAME=
# SMTP_PASSWORD=
# SMTP_FROM_EMAIL=hello@example.com
# SMTP_REPLY_EMAIL=hello@example.com
# SMTP_TLS_CIPHERS=
# SMTP_SECURE=true

# The default interface language. See translate.getoutline.com for a list of
# available language codes and their rough percentage translated.
DEFAULT_LANGUAGE=en_US

# Optionally enable rate limiter at application web server
RATE_LIMITER_ENABLED=true

# Configure default throttling parameters for rate limiter
RATE_LIMITER_REQUESTS=1000
RATE_LIMITER_DURATION_WINDOW=60

# Iframely API config
# IFRAMELY_URL=
# IFRAMELY_API_KEY=

# Enable unsafe-inline in script-src CSP directive
# Setting it to true allows React dev tools add-on in
# Firefox to successfully detect the project
DEVELOPMENT_UNSAFE_INLINE_CSP=false
```

### 添加 nginx 配置

server stream 都少不了

```nginx
stream {
    map $ssl_preread_server_name $name {
...
+       outline.example.com outline;
    }
...
...
+   upstream outline {
+       server 127.0.0.3001;
+   }
```

顺便要加 TLS 配置，不要忘记。我用了 wildcard, 复用分离出来的 TLS 配置文件就行了。

```nginx
server {
    listen 127.0.0.1:3001 ssl; http2 on;
    server_name  outline.example.com;

    # TLS settings
    include /etc/nginx/conf.d/xx-tls.conf;
    # enforce authenticated pull
    include /etc/nginx/conf.d/xx-verify-client.conf;

    location / {
        proxy_pass http://127.0.0.1:3000/;

        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;

        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;proxy_set_header Host $host;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Scheme $scheme;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }
}
```

其他的一些就不再提了。有坑慢慢填。

## 初次启动

`nginx -t` 检查一下配置，然后 `systemctl reload nginx` 重启 nginx. 

容器部分，先启动 redis 和 postgres, 再启动 app 本体。

```bash
docker compose up redis postgres
```

然后另外开个 tty（用 tmux/screen 更快）

```bash
docker compose up outline
```

观察一下启动好了以后，访问 outline 实例，用 OIDC 登录。

![](/asset/img/EX00477/login.webp)

跳转到授权界面，权限要得属实有些多了，forgejo 什么时候修

![](/asset/img/EX00477/auth.webp)

然后就能进来了，尽情玩耍吧。

![](/asset/img/EX00477/home.webp)


